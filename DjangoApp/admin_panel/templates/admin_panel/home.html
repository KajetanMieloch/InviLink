{% extends "base.html" %}
{% block content %}
{% load static %}
<style>
  :root {
    --transition-speed: 0.5s;
    --primary-color: #000000; /* czarny */
    --secondary-color: #f1c40f; /* żółty */
    --accent-color: #8e44ad; /* fioletowy */
    /* Gradient colors for Solana-like effect */
    --gradient-start: #1e90ff; /* niebieski */
    --gradient-end: #8e44ad;   /* fioletowy */
  }

  html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    background: #111;
    font-family: sans-serif;
  }

  /* Modal overlay covers entire screen */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  /* Modal card styling */
  .modal {
    background: #000;
    border: 2px solid var(--accent-color);
    border-radius: 8px;
    width: 95%;
    height: 95%;
    margin-top: 1.25%;
    margin-left: 2.5%;
    padding: 30px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    text-align: center;
    color: white;
  }

  .modal-content {
    overflow-y: auto;
    background-color: #000;
  }

  .modal h1 {
    font-size: 2rem;
    margin-bottom: 20px;
  }

  .modal p {
    font-size: 1rem;
    line-height: 1.5;
    margin-bottom: 20px;
  }

  /* Footer container for modal actions */
  .modal-footer {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* Container for the buttons at the bottom */
  .button-row {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 20px;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
    border: none;
    transition: background 0.3s, color 0.3s;
    text-decoration: none;
  }

  /* Filled gradient button: "Take me to event zone" */
  .btn-filled {
    background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    color: white;
  }

  /* Outline button with gradient border and gradient text: "Take me to organiser site" */
  .btn-outline {
    background: transparent;
    border: 2px solid transparent;
    border-image: linear-gradient(45deg, var(--gradient-start), var(--gradient-end)) 1;
    border-radius: 4px;
    padding: 10px 20px;
    font-size: 1rem;
    background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  /* Yellow button with black text: "im an admin" */
  .btn-yellow {
    background: var(--secondary-color);
    color: var(--primary-color);
    border: none;
    border-radius: 4px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
  }

  /* Checkbox container styling */
  .checkbox-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 10px;
  }

  .checkbox-container input {
    margin-right: 10px;
    transform: scale(1.2);
  }
</style>

<div class="modal-overlay" id="adminModal">
  <div class="modal">
    <div class="modal-content">
      <h1>Administrative Access Only</h1>
      <p>
        This page is strictly for the contract manager. If you are a participant, you are most likely looking for the
        Event Zone, and if you are an organizer, please visit the Organiser Site.
        </br>
        If you need anny help, please contact us at <a href="mailto: 339562@uwr.edu.pl"> 339562@uwr.edu.pl </a> <strong> I will be happy to help you! </strong>
      </p>
    </div>
    <div class="modal-footer">
      <div class="button-row">
        <a class="btn btn-filled" href="https://invilink.bieda.it/explore" target="_blank" rel="noopener noreferrer">
          Take me to event zone
        </a>
        <a class="btn btn-outline" href="https://invilink.bieda.it/organizer" target="_blank" rel="noopener noreferrer">
          Take me to organiser site
        </a>
        <button class="btn btn-yellow" id="adminBtn" disabled>
          im an admin
        </button>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="ackCheckbox">
        <label for="ackCheckbox">I understand</label>
      </div>
    </div>
  </div>
</div>

<!-- Placeholder for Admin Interface (a blank white page for now) -->
<div id="adminContent" style="display: none; min-height: 100vh; padding: 40px; text-align: center;">
  <h1>Admin Dashboard</h1>
  <h2>Initialise Event Registry and Organizer Pool</h2>
  <button onclick="initializeAdmin()">Initialise</button>

  <div id="log"></div>
  
</div>


<!-- Javascript to handle the modal and admin content -->
<script>
  const ackCheckbox = document.getElementById('ackCheckbox');
  const adminBtn = document.getElementById('adminBtn');
  const adminModal = document.getElementById('adminModal');
  const adminContent = document.getElementById('adminContent');

  // Enable "im an admin" button when the checkbox is checked
  ackCheckbox.addEventListener('change', function() {
    adminBtn.disabled = !this.checked;
  });

  // When "im an admin" is clicked, hide the modal and show the admin content
  adminBtn.addEventListener('click', function() {
    adminModal.style.display = 'none';
    adminContent.style.display = 'block';
  });
</script>



<!-- Javascript to handle initialisation of the Event Registry, Organizer Pool -->
<script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<script src="{% static 'js/logmsg.js' %}"></script>
<script src="{% static 'js/getConstants.js' %}"></script>
<script>


    async function initializeAdmin() {
     
     
      const constants = await getConstants();
      const PROGRAM_ID = new solanaWeb3.PublicKey(constants.PROGRAM_ID); // tu dopiero tworzysz obiekt
      const NETWORK = constants.NETWORK;


      //Check if Phantom Wallet is available
      if (!window.phantom || !window.phantom.solana) {
        alert("Phantom Wallet is required!");
        return;
      }
      const provider = window.phantom.solana;
      if (!provider.isConnected) {
        await provider.connect();
      }
      //Get user's public key
      const walletPublicKey = provider.publicKey;
      logMessage("Your public key: " + walletPublicKey.toBase58());
      //Connect to Solana Devnet
      const connection = new solanaWeb3.Connection(NETWORK, "confirmed");
      //ID of the Anchor program
      //Calculate PDA (Program Derived Address) for `event_registry`
      const [eventRegistry] = await solanaWeb3.PublicKey.findProgramAddress(
          [new TextEncoder().encode("event_registry")],  // Seed compatible with Anchor.toml
          PROGRAM_ID
      );

        //Calculate PDA (Program Derived Address) for `organizers_pool`
      const [organizersPool] = await solanaWeb3.PublicKey.findProgramAddress(
          [new TextEncoder().encode("organizers_pool")],  // Seed compatible with Anchor.toml
          PROGRAM_ID
      );

      logMessage("Organizers Pool PDA: " + eventRegistry.toBase58());

      //eventRegistryDiscriminator for the `initialize_event_registry` function
      const eventRegistryDiscriminator = new Uint8Array([222, 221, 108, 11, 214, 161, 6, 121]);
      const organizersPoolDiscriminator = new Uint8Array([213, 153, 51, 23, 150, 192, 71, 166]);

      //Create transaction instruction
      const eventRegistryInstruction = new solanaWeb3.TransactionInstruction({
          keys: [
              { pubkey: eventRegistry, isSigner: false, isWritable: true },  // Konto PDA
              { pubkey: walletPublicKey, isSigner: true, isWritable: true },     // Payer
              { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false }  // System Program
          ],
          programId: PROGRAM_ID,
          data: eventRegistryDiscriminator // We send only 8 bytes from the function eventRegistryDiscriminator
      });

      const organizersPoolInstruction = new solanaWeb3.TransactionInstruction({
          keys: [
              { pubkey: organizersPool, isSigner: false, isWritable: true },  // Konto PDA
              { pubkey: walletPublicKey, isSigner: true, isWritable: true },     // Payer
              { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false }  // System Program
          ],
          programId: PROGRAM_ID,
          data: organizersPoolDiscriminator // We send only 8 bytes from the function eventRegistryDiscriminator
      });

      try {
          //Create transaction
          let transaction = new solanaWeb3.Transaction();
          transaction.add(eventRegistryInstruction);
          transaction.add(organizersPoolInstruction);

          transaction.feePayer = walletPublicKey;
          const { blockhash } = await connection.getLatestBlockhash();
          transaction.recentBlockhash = blockhash;

          //Sign transaction by the user
          const signedTransaction = await provider.signTransaction(transaction);

          //Send transaction
          const txSignature = await connection.sendRawTransaction(signedTransaction.serialize());
          logMessage("Transaction sent: " + txSignature);

          //Confirm transaction
          const confirmation = await connection.confirmTransaction(txSignature, "confirmed");
          if (confirmation.value.err) {
              throw new Error("Transaction failed: " + JSON.stringify(confirmation.value.err));
          }

          logMessage("Organizers Pool and Event Registry initialized! Tx Sig: " + txSignature);
      } catch (err) {
          logMessage("Error: " + err);
      }
    }

</script>

{% endblock %}
