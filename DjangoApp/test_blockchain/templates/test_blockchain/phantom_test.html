<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Test</title>
    <style>
        /* Ogólny styl dla przycisków */
        .button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }

        .button:hover {
            background-color: #0056b3;
        }

        /* Ukryj przycisk desktop na mobile */
        .desktop-button {
            display: none;
        }

        /* Ukryj przycisk mobile na desktop */
        .mobile-button {
            display: none;
        }

        /* Wyświetl przycisk desktop na dużych ekranach */
        @media (min-width: 768px) {
            .desktop-button {
                display: block;
            }
        }

        /* Wyświetl przycisk mobile na małych ekranach */
        @media (max-width: 767px) {
            .mobile-button {
                display: block;
            }
        }
    </style>
</head>
<body>
    <h1>Phantom Test</h1>
    <button class="button desktop-button" onclick="callSmartContractDesktop()">Wyślij SOL (Desktop)</button>
    <button class="button mobile-button" onclick="callSmartContractDesktop()">Wyślij SOL (Mobile)</button>
    <p id="blockchainData"></p>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"> </script>

    <script>



if (typeof Buffer === 'undefined') {
    window.Buffer = {
        from: (str, encoding) => {
            if (encoding === 'base64') {
                return Uint8Array.from(atob(str), c => c.charCodeAt(0));
            } else if (encoding === 'hex') {
                const bytes = [];
                for (let i = 0; i < str.length; i += 2) {
                    bytes.push(parseInt(str.substr(i, 2), 16));
                }
                return Uint8Array.from(bytes);
            }
            throw new Error('Unsupported encoding: ' + encoding);
        },
        alloc: (size) => new Uint8Array(size), // Obsługa Buffer.alloc
    };
}


async function fetchBlockchainData(signature) {

        console.log("signature", signature);
        const response = await fetch(`http://127.0.0.1:8000/test_blockchain/blockchain-data/${signature}`);
        const data = await response.json();
        console.log("data", data);
        document.getElementById('blockchainData').innerText = JSON.stringify(data, null, 2);
}

const getProvider = () => {
    if ('phantom' in window) {
        const provider = window.phantom?.solana;

        if (provider?.isPhantom) {
            return provider;
        }
    }
    alert('Phantom Wallet is not installed. Please install it from https://phantom.app/');
    open('https://phantom.app/', '_blank');
    return null;
};

async function callSmartContract() {
    const provider = getProvider();
    if (!provider) {
        console.error("Provider not found. Make sure Phantom Wallet is connected.");
        return;
    }

    const network = 'https://api.devnet.solana.com';
    const connection = new solanaWeb3.Connection(network);

    try {
        const transaction = new solanaWeb3.Transaction();

        // Twój Program ID
        const programId = new solanaWeb3.PublicKey("5iHT8dpa6TJssXi3VXGAa1W7nVzGxT18dj6PocxW81m9");

        if (!provider.publicKey) {
            await provider.connect();
        }

        const senderPublicKey = provider.publicKey;

        // Pobierz ostatni blockhash
        const { blockhash } = await connection.getLatestBlockhash();

        // Ustaw fee payer i blockhash
        transaction.recentBlockhash = blockhash;
        transaction.feePayer = senderPublicKey;

        // 8-bajtowy identyfikator instrukcji (discriminator z IDL)
        const instructionIdentifier = new Uint8Array([46, 139, 65, 78, 244, 171, 123, 238]);

        // Dodaj instrukcję wywołującą smart contract
        const instruction = new solanaWeb3.TransactionInstruction({
            keys: [
                {
                    pubkey: senderPublicKey, // Użytkownik
                    isSigner: true,
                    isWritable: true,
                },
                {
                    pubkey: solanaWeb3.SystemProgram.programId, // Program systemowy
                    isSigner: false,
                    isWritable: false,
                },
            ],
            programId: programId,
            data: instructionIdentifier, // 8-bajtowy identyfikator instrukcji
        });

        transaction.add(instruction);

        console.log("Transaction object:", transaction);

        // Symulacja transakcji
        const simulation = await connection.simulateTransaction(transaction);
        console.log('Simulation logs:', simulation.value.logs);

        if (simulation.value.err) {
            throw new Error('Transaction simulation failed. Check logs for details.');
        }

        // Podpisz i wyślij transakcję
        const { signature } = await provider.signAndSendTransaction(transaction);
        console.log('Transaction signature:', signature);

        // Potwierdź transakcję
        const confirmation = await connection.confirmTransaction(signature);
        if (confirmation.value.err) {
            throw new Error('Transaction confirmation failed.');
        }

        alert('Transaction successful!');
        //Wait 4 seconds for the transaction to be confirmed
        await new Promise(resolve => setTimeout(resolve, 4000));
        fetchBlockchainData(signature);
    } catch (error) {
        console.error('Transaction failed:', error);
        alert(`Transaction failed: ${error.message}`);
    }
}


async function callSmartContractDesktop() {
    if (window.solana && window.solana.isPhantom) {
        try {
            await callSmartContract();
        } catch (error) {
            alert('Connection to Phantom Wallet was rejected.');
        }
    } else {
        alert('Phantom Wallet is not installed. Please install it from https://phantom.app/');
        open('https://phantom.app/', '_blank');
    }
}




        // function sendSolMobile() {
        //     const dappEncryptionPublicKey = '{{ dapp_encryption_public_key }}';
        //     const appUrl = 'http://192.168.1.211:8000';
        //     const redirectLink = 'http://192.168.1.211:8000/test_blockchain/phantom_callback';

        //     const deepLink = `https://phantom.app/ul/v1/connect?app_url=${encodeURIComponent(appUrl)}&dapp_encryption_public_key=${dappEncryptionPublicKey}&redirect_link=${encodeURIComponent(redirectLink)}&cluster=devnet`;

        //     window.location.href = deepLink;
        // }




    </script>
</body>
</html>
