<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Kolekcja NFT - INVI</title>
  <!-- Solana Web3 -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <!-- Metaplex JS (umożliwia pobranie metadanych NFT) -->
  <script src="https://unpkg.com/@metaplex/js/dist/metaplex.umd.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #nftContainer { display: flex; flex-wrap: wrap; gap: 20px; margin-top: 20px; }
    .nftItem { border: 1px solid #ccc; padding: 10px; width: 200px; }
    .nftImage { width: 100%; height: auto; }
    #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Kolekcja NFT (INVI)</h1>
  <button id="connectBtn">Połącz Phantom Wallet</button>
  <div id="walletAddress"></div>
  <div id="nftContainer"></div>
  <div id="log"></div>

  <script>
    // Funkcja do logowania komunikatów
    function log(message) {
      const logEl = document.getElementById("log");
      logEl.textContent += message + "\n";
      console.log(message);
    }

    // Inicjalizacja połączenia z Solaną
    const connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com", "confirmed");
    // Stałe: Token Program i Metadane (Metaplex)
    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
    const METADATA_PROGRAM_ID = new solanaWeb3.PublicKey("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s");

    let walletPublicKey = null;

    // Funkcja do połączenia z Phantom Wallet
    async function connectWallet() {
      if (!window.solana) {
        alert("Phantom Wallet nie jest zainstalowany!");
        return;
      }
      try {
        const resp = await window.solana.connect();
        walletPublicKey = resp.publicKey;
        document.getElementById("walletAddress").innerText = "Połączony wallet: " + walletPublicKey.toString();
        log("Wallet połączony: " + walletPublicKey.toString());
        fetchNFTs();
      } catch (err) {
        log("Błąd łączenia z portfelem: " + err.message);
      }
    }

    // Funkcja pobierająca NFT z portfela i filtrująca według symbolu "INVI"
    async function fetchNFTs() {
      if (!walletPublicKey) return;
      try {
        // Pobieramy token accounts użytkownika
        const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
          walletPublicKey,
          { programId: TOKEN_PROGRAM_ID }
        );
        log("Znaleziono " + tokenAccounts.value.length + " kont tokenów.");

        const nftContainer = document.getElementById("nftContainer");
        nftContainer.innerHTML = "";

        // Przetwarzamy każdy token account
        for (const accountInfo of tokenAccounts.value) {
          const tokenAmount = accountInfo.account.data.parsed.info.tokenAmount;
          // Wstępna filtracja NFT (typowo NFT mają 1 sztukę i 0 miejsc dziesiętnych)
          if (tokenAmount.uiAmount === 1 && tokenAmount.decimals === 0) {
            const mintAddress = accountInfo.account.data.parsed.info.mint;
            log("Przetwarzam token NFT, mint: " + mintAddress);
            try {
              // Obliczamy PDA dla konta metadanych NFT wg schematu: ["metadata", METADATA_PROGRAM_ID, mint]
              const metadataPDA = await window.metaplex.programs.metadata.Metadata.getPDA(
                new solanaWeb3.PublicKey(mintAddress)
              );
              // Ładujemy konto metadanych
              const metadataAccount = await window.metaplex.programs.metadata.Metadata.load(connection, metadataPDA);
              // Odczytujemy dane – struktura: { name, symbol, uri, ... }
              const metadataData = metadataAccount.data.data;
              // Sprawdzamy, czy symbol NFT to "INVI"
              if (metadataData.symbol === "INVI") {
                // Pobieramy dodatkowe dane (np. obrazek) z pliku JSON umieszczonego pod adresem uri
                const response = await fetch(metadataData.uri);
                const metadataJSON = await response.json();

                // Tworzymy element do wyświetlenia NFT
                const nftDiv = document.createElement("div");
                nftDiv.className = "nftItem";
                nftDiv.innerHTML = `
                  <h3>${metadataData.name}</h3>
                  <img class="nftImage" src="${metadataJSON.image}" alt="${metadataData.name}">
                  <p>Symbol: ${metadataData.symbol}</p>
                `;
                nftContainer.appendChild(nftDiv);
              }
            } catch (err) {
              log("Błąd przetwarzania NFT (mint: " + mintAddress + "): " + err.message);
            }
          }
        }
      } catch (err) {
        log("Błąd pobierania token accounts: " + err.message);
      }
    }

    // Obsługa przycisku do połączenia z portfelem
    document.getElementById("connectBtn").addEventListener("click", connectWallet);
  </script>
</body>
</html>
