<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mint Token and TicketNFT</title>
  <!-- Solana Web3.js (IIFE) -->
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.js"></script>
</head>
<body>
<h1>Mint SPL Token and TicketNFT</h1>

<!-- Form for Minting SPL Token -->
<h2>Mint SPL Token</h2>
<button onclick="mintOneToken()">Mint 1 SPL Token</button>

<!-- Form for Minting TicketNFT -->
<h2>Mint TicketNFT</h2>
<form>
  <label>Event ID:</label><br>
  <input type="text" id="eventId" value="myEvent123"><br><br>

  <label>Ticket ID:</label><br>
  <input type="text" id="ticketId" value="ticket001"><br><br>

  <label>Price (lamports):</label><br>
  <input type="number" id="price" value="100000000"><br><br>

  <label>Attributes:</label><br>
  <input type="text" id="attributes" value="VIP"><br><br>

  <button type="button" onclick="mintTicketNFT()">Mint TicketNFT</button>
</form>

<script>
  // ------------------------------------------------
  // Parametry Programu
  // ------------------------------------------------
  const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA");
  const MINT_ADDRESS = new solanaWeb3.PublicKey("Ad36vwAnZDWkHSBHg6JYhviSgUpKpFkp49n9iBBqoKZt");
  const DEST_TOKEN_ACCOUNT = new solanaWeb3.PublicKey("FsZ3pTfhcUyP7iLRyfdy7KvGgijtQ8DZD8nVnq7nc4ok");

  const PROGRAM_ID_STR = "98cFPPr2S2UjSthTxmjNsPei9Ty6vFcsLkyWLsTz4CTY";
  const PROGRAM_ID = new solanaWeb3.PublicKey(PROGRAM_ID_STR);

  // Discriminator dla funkcji `mint_ticket` (z IDL)
  const MINT_TICKET_DISCRIMINATOR = [159, 167, 223, 60, 138, 6, 23, 29];

  // ------------------------------------------------
  // Funkcje pomocnicze
  // ------------------------------------------------
  function padOrTruncTo64Bytes(str) {
    // Konwertuje string do UTF-8, obcina/powieksza do 64 bajtów
    const encoder = new TextEncoder();
    const utf8 = encoder.encode(str);
    const arr = new Uint8Array(64);
    arr.set(utf8.slice(0, 64));
    return arr;
  }

  function numberToLE8(value) {
    const big = BigInt(value);
    const bytes = new Uint8Array(8);
    for (let i = 0; i < 8; i++) {
      bytes[i] = Number((big >> BigInt(8 * i)) & BigInt(0xff));
    }
    return bytes;
  }

  async function getPhantomProvider() {
    if ("solana" in window && window.solana.isPhantom) {
      try {
        const provider = window.solana;
        await provider.connect();
        return provider;
      } catch (err) {
        console.error("User rejected the connection:", err);
        alert("Connection to Phantom rejected.");
        return null;
      }
    }
    alert("Phantom Wallet not found!");
    return null;
  }

  // ------------------------------------------------
  // Funkcja: Mint SPL Token
  // ------------------------------------------------
  async function mintOneToken() {
    try {
      const provider = await getPhantomProvider();
      if (!provider) return;

      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"), "confirmed");
      const ownerPubkey = provider.publicKey;
      console.log("Mint Authority pubkey:", ownerPubkey.toBase58());

      // Przygotuj instrukcję SPL Token MintTo
      const instructionData = new Uint8Array([7, ...numberToLE8(1000000000)]); // 7 = MintTo, 1 token = 10^9 lamports

      const keys = [
        { pubkey: MINT_ADDRESS, isSigner: false, isWritable: true }, // mint
        { pubkey: DEST_TOKEN_ACCOUNT, isSigner: false, isWritable: true }, // destination
        { pubkey: ownerPubkey, isSigner: true, isWritable: false }, // authority
      ];

      const mintToIx = new solanaWeb3.TransactionInstruction({
        programId: TOKEN_PROGRAM_ID,
        keys,
        data: instructionData,
      });

      // Tworzymy transakcję
      let transaction = new solanaWeb3.Transaction().add(mintToIx);
      transaction.feePayer = ownerPubkey;
      const { blockhash } = await connection.getLatestBlockhash();
      transaction.recentBlockhash = blockhash;

      // Sign and send
      const signedTx = await provider.signTransaction(transaction);
      const txSignature = await connection.sendRawTransaction(signedTx.serialize());
      console.log("Tx Signature:", txSignature);

      // Potwierdzenie
      const confirmation = await connection.confirmTransaction(txSignature, "confirmed");
      if (confirmation.value.err) {
        throw new Error("Transaction failed: " + JSON.stringify(confirmation.value.err));
      }

      alert("Minted 1 SPL Token! Tx Sig: " + txSignature);
    } catch (err) {
      console.error("Error minting SPL token:", err);
      alert("Error: " + err.message);
    }
  }

  // ------------------------------------------------
  // Funkcja: Mint TicketNFT
  // ------------------------------------------------
  async function mintTicketNFT() {
    console.log("Mint TicketNFT Function Start");

    try {
      // 1. Pobierz provider (Phantom)
      const provider = await getPhantomProvider();
      if (!provider) return;

      // 2. Utwórz połączenie z devnet
      const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("devnet"), "confirmed");

      // 3. Public key ownera (Phantom)
      const ownerPubkey = provider.publicKey;
      console.log("Owner PublicKey:", ownerPubkey.toBase58());

      // 4. Odczytaj dane z formularza
      const eventIdStr = document.getElementById("eventId").value;
      const ticketIdStr = document.getElementById("ticketId").value;
      const priceVal = parseInt(document.getElementById("price").value, 10);
      const attributesStr = document.getElementById("attributes").value;

      console.log("User input:", { eventIdStr, ticketIdStr, priceVal, attributesStr });

      // 5. Zamień stringi na 64-bajtowe tablice
      const eventIdBytes = padOrTruncTo64Bytes(eventIdStr);
      const ticketIdBytes = padOrTruncTo64Bytes(ticketIdStr);
      const attributesBytes = padOrTruncTo64Bytes(attributesStr);

      // 6. Generuj Keypair dla nowego konta 'ticket'
      const ticketKeypair = solanaWeb3.Keypair.generate();
      console.log("Ticket Keypair publicKey:", ticketKeypair.publicKey.toBase58());

      // 7. Oblicz rentExemption
      const SPACE = 250; // Jak w programie (8 + 32 + 64 + 64 + 8 + 1 + 64 = 233, zapas 250)
      const lamportsForRent = await connection.getMinimumBalanceForRentExemption(SPACE);

      // 8. Instrukcja createAccount (dla #[account(init)])
      // Ponieważ program Anchor z atrybutem 'init' już obsługuje tworzenie konta, **nie dodawaj** tutaj instrukcji `createAccount`
      // Zamiast tego, wywołaj tylko `mint_ticket` z odpowiednimi argumentami

      // 9. Zbuduj data do metody `mint_ticket`: 
      //    [8-bajtów discriminator] + [64 event_id] + [64 ticket_id] + [8 price LE] + [64 attributes]
      const data = new Uint8Array([
        ...MINT_TICKET_DISCRIMINATOR,
        ...eventIdBytes,
        ...ticketIdBytes,
        ...numberToLE8(priceVal),
        ...attributesBytes,
      ]);

      // 10. Instrukcja wywołania Programu
      const mintIx = new solanaWeb3.TransactionInstruction({
        keys: [
          { pubkey: ticketKeypair.publicKey, isSigner: true, isWritable: true }, // ticket
          { pubkey: ownerPubkey, isSigner: true, isWritable: true },           // owner
          { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false }, // system_program
        ],
        programId: PROGRAM_ID,
        data: data,
      });

      // 11. Stwórz transakcję z 1 instrukcją (tylko `mint_ticket`)
      let transaction = new solanaWeb3.Transaction().add(mintIx);
      transaction.feePayer = ownerPubkey;
      const blockhashObj = await connection.getLatestBlockhash();
      transaction.recentBlockhash = blockhashObj.blockhash;

      // 12. partialSign ticketKeypair (jest isSigner w mintIx)
      transaction.partialSign(ticketKeypair);

      // 13. Poproś Phantom o podpis
      const signedTx = await provider.signTransaction(transaction);

      // 14. Wyślij transakcję
      const txSignature = await connection.sendRawTransaction(signedTx.serialize());
      console.log("Transaction Signature:", txSignature);

      // 15. Potwierdzenie
      const confirmation = await connection.confirmTransaction(txSignature, "confirmed");
      if (confirmation.value.err) {
        throw new Error("Transaction failed: " + JSON.stringify(confirmation.value.err));
      }

      alert("Minted TicketNFT! Tx Sig: " + txSignature);

    } catch (err) {
      console.error("Error minting TicketNFT:", err);
      alert("Error: " + err.message);
    }
  }
</script>
</body>
</html>
